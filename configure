#!/usr/bin/env bash

# configure: Makefile generator
# Copyright Â© 2011 Lukas Martini

# This file is part of Xelix.
#
# Xelix is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Xelix is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Xelix. If not, see <http://www.gnu.org/licenses/>.

# Update submodules
git submodule update --init 1> /dev/null

# Get files
files=`find -L src -type f -iregex "^.*\.\(c\|asm\)" | tr '\n' '  '`

echo "# This file has been generated by ./configure. You usually don't \
want to change it manually.\n" > Makefile
echo "include Makefile.header" >> Makefile

echo -n "xelix.bin: linker.ld" >> Makefile

for i in $files
do
	echo -n " ${i%\.*}" >> Makefile

	if [ ${i##*.} == "asm" ]
	then
		echo -n "-asm" >> Makefile
	fi

	echo -n ".o" >> Makefile
done

echo >> Makefile
echo "	\$(LD) -melf_i386 -T linker.ld -nostdlib -o xelix.bin \$(LDFLAGS) $^" >> Makefile
echo "	chmod -x xelix.bin" >> Makefile


for i in $files
do
	deps=`gcc -nostdinc -I src -MM $i -MQ $i 2> /dev/null | tr ' \n ' ' ' | tr ' \\\  ' ' '`
	deps=($deps)
	unset deps[1]
	echo ${deps[*]} >> Makefile
done

echo "include Makefile.footer" >> Makefile
